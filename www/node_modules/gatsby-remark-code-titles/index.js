'use strict';

var _unistUtilVisit = require('unist-util-visit');

var _unistUtilVisit2 = _interopRequireDefault(_unistUtilVisit);

var _queryString = require('query-string');

var _queryString2 = _interopRequireDefault(_queryString);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

module.exports = function gatsbyRemarkCodeTitles({ markdownAST }, { className: customClassName }) {
  (0, _unistUtilVisit2.default)(markdownAST, 'code', (node, index) => {
    const [language, query] = (node.lang || '').split(':');
    const { title } = _queryString2.default.parse(query);
    if (!title || !language) {
      return;
    }

    const className = ['gatsby-code-title'].concat(customClassName || []);

    const titleNode = {
      type: 'html',
      value: `
<div class="${className.join(' ').trim()}">${title}</div>
      `.trim()
    };

    /*
     * Splice a node back into the Markdown AST with custom title
     */
    markdownAST.children.splice(index, 0, titleNode);

    /*
     * Reset to just the language
     */
    node.lang = language;
  });
};